<html>
<head>
<script src="./jquery-2.1.1.min.js"></script>
<script>


var colors = ['col0', 'col1', 'col2', 'col3'];

function pad(number,length) {
    var str = '' + number;
    while (str.length < length)
        str = ' ' + str;
    return str;
}

View = function(div, matrix){
    this.matrix = matrix;
    this.div = div;
    this.render();
    this.clicks=0;

    that = this;

    function is_touch_device() {
      return 'ontouchstart' in window // works on most browsers 
            || 'onmsgesturechange' in window; // works on ie10
    };
    var actionEvent = 'click';
    if (is_touch_device()){
        actionEvent = 'touchstart';
    }
    $('.item').on(actionEvent, function(evt){
        var heart = $($(this).find('.heart')[0]);
        // rc = row column
        var rc = heart.attr('id').split('_');
        var c = rc[0];
        var r = rc[1];
        var h = heart.attr('data-color');
        // deep copy
        matrix.pushState();
        var hits = matrix.flood(r, c, h);
        // TODO move this to Matrix (combined history: mtx, hearts, score)
        $('#score_hearts').html(hits);
        if (hits==1){
            //restore
            matrix.popState();
            hits=0;
        }
        $('#score_hearts').html(hits);
        //console.time('render');
        that.render();
        //console.timeEnd('render');
        matrix.collapse();
        that.render();
        //console.log(matrix.mtx);
    });
}

View.prototype.toString = function(withBuffer){
    return this.matrix.toString(withBuffer);
}

View.prototype.render = function(){
    for (var i=1;i<this.matrix.rows+1;i++){
        // create a new row if not already available
        if($('#row'+i).length==0){
            this.div.append($('<div id="row'+i+'" class="row"></div>'));
        }
        for (var j=1;j<this.matrix.cols+1;j++){ 
            var color = this.matrix.mtx[j][i];
            //var cell = $('[id^='+i+'_'+j+']');  // jquery regular expression SLOWWWWW!!!
            var cell = $('#'+i+'_'+j);
            if(cell.length==0){
                // create a fresh cell
                $('#row'+i).append($('<div class="item"><div class="heart ' + colors[color] + '" data-color="'+color+'" id="'+i+'_'+j+'"></div></div>'));
                //$('#row'+i).append($('<div class="item"><img src="heart.svg" style="width:100%;" class="heart ' + colors[color] + '" data-color="'+color+'" id="'+i+'_'+j+'"></div>'));
                //$('#row'+i).append($('<div class="item"><object type="image/svg+xml" data="heart.svg" class="heart ' + colors[color] + '" data-color="'+color+'" id="'+i+'_'+j+'"></div>'));
            }
            else{
                // remove all classes and set the right color
                cell.removeClass();
                cell.attr('data-color',color);
                if (color>=0){
                    cell.addClass('heart').addClass(colors[color]);
                }
            }
        }
    }
}

Matrix = function(rows, cols){
    this.rows = rows;
    this.cols = cols;
    // create matrix with a buffer around it filled with -1
    this.mtx = [];
    this.history = new Array(10);
    for (var i=0;i<cols+2;i++){
        var x = [];
        for (var j=0;j<rows+2;j++){
            x.push(-1);
        }
        this.mtx.push(x);
    }
    for (var i=1;i<cols+1;i++){
        for (var j=1;j<rows+1;j++){
            var val = Math.floor((Math.random() * colors.length));
            this.mtx[i][j]=val;
        }
    }
}
Matrix.prototype.toString = function(){
    this.toString(true);
}
Matrix.prototype.toString = function(withBuffer){
    var s = []
    var colstart = 1, colend=1;
    var rowstart = 1, rowend=1;
    if (withBuffer){
        colstart = 0, colend=2;
        rowstart = 0, rowend=2;
    }
    for (var i=rowstart;i<this.rows+rowend;i++){
        var r='';
        for (var j=colstart;j<this.cols+colend;j++){
            r+=(pad(this.mtx[j][i],2)+', ');
        }
        s.push( r );
    }
    return s.join("\n\n");
}
Matrix.prototype.pushState = function(){
    var m = $.extend(true, [], this.mtx);
    //var m = JSON.decode(JSON.encode(this.mtx));
    this.history.push(m);
    this.history.shift();
}
Matrix.prototype.popState = function(){
    var m = this.history.pop();
    this.history.unshift(undefined);
    if (m==undefined){
        // we return a copy of current version
        m = $.extend(true, [], this.mtx); // <== deep copy of object
        //m = JSON.decode(JSON.encode(this.mtx));
    }
    this.mtx = null;
    this.mtx = m;
    return m;
}
Matrix.prototype.flood = function(row, col, c){
    //console.log('flood: ', row, col, c)
    if (this.mtx[row][col]!=c){
        return 0;
    }
    console.log(this.mtx)
    this.mtx[row][col]=(-1);
    console.log(this.mtx)
    row = parseInt(row);
    col = parseInt(col);
    var hits = 1+this.flood(row-1,col,c)+this.flood(row+1,col,c)+this.flood(row,col-1,c)+this.flood(row,col+1,c);
    return hits;
}

Matrix.prototype.collapse = function(){
    // detect empty cell, and collapse down (adding -1 to top)
    for (var c=this.cols+1;c>0;c--){ // going from back to front!
        var col = this.mtx[c];
        for (var i=1;i<this.rows+1;i++){
            //console.log(c,i, col)
            if(col[i]==-1){
                // splice removes this element and returns that element
                // unshift puts that element in front of the array
                // NOTE:  splice returns an array(!) hence [0]
                col.unshift(col.splice(i,1)[0]);
            }
            //console.log(c, col)
        }
    }
    // detect empty columns, and if collapse to left
    function isEmpty(element, index, array){
        return element == -1;
    }
    for (var c=this.cols+1;c>0;c--){ // going from back to front!
        if (this.mtx[c].every(isEmpty)){
            // splice removes this element and returns that element
            // push adds that element to the front of the array with columns
            // NOTE:  splice returns an array(!) hence [0]
            this.mtx.push(this.mtx.splice(c,1)[0]);
            //c--; // rewind one
        }
    }
    return;
}

Matrix.prototype.isfinished = function(){
    // TODO
}


$( document ).ready(function() {
    m = new Matrix(15,15);
    //m = new Matrix(11,11);
    //m = new Matrix(4,4);
    //m = new Matrix(6,6);
    //m = new Matrix(2,2);
    v = new View($('#matrix'), m);
    console.log(m.toString());
});
</script>
</head>
<body>

<!-- http://www.cssportal.com/css3-shapes/ -->

<style>
/* svg only used for hearts: fill enclosing div 100%*/
svg{
    width:100%;
    height:100%;
}
.row {
    clear: both;
}
.item {
    float: left;
    height: 24px;
    width: 24px;
    border: inset white .5px;
    padding: 0 1px 0 0;
    background: white; /* gray */
}

/* '#d7191c', '#fdae61', '#abdda4', '#2b83ba' */
.heart.col0:before, .heart.col0:after {
    background: #d7191c;
}
.heart.col1:before, .heart.col1:after {
    background: #fdae61;
}
.heart.col2:before, .heart.col2:after {
    background: #abdda4;
}
.heart.col3:before, .heart.col3:after {
    background: #2b83ba;
}
.heart { 
    position: relative;
}
.heart:before, .heart:after {
   position: absolute;
   content: "";
   left: 12px; 
   top: 4px;
   width: 12px;
   height: 18px;
   background: blue;
   border-radius: 50px 50px 0 0;
   -moz-border-radius: 50px 50px 0 0;
   -webkit-transform: rotate(-45deg);
   -moz-transform: rotate(-45deg);
   -ms-transform: rotate(-45deg);
   -o-transform: rotate(-45deg);
   transform: rotate(-45deg);
   -webkit-transform-origin: 0 100%;
   -moz-transform-origin: 0 100%;
   -ms-transform-origin: 0 100%;
   -o-transform-origin: 0 100%;
   transform-origin: 0 100%;
}
.heart:after { 
left: 0; 
   -webkit-transform: rotate(45deg); 
   -moz-transform: rotate(45deg); 
   -ms-transform: rotate(45deg); 
   -o-transform: rotate(45deg);
   transform: rotate(45deg);
   -webkit-transform-origin: 100% 100%;
   -moz-transform-origin: 100% 100%;
   -ms-transform-origin: 100% 100%;
   -o-transform-origin: 100% 100%;
   transform-origin :100% 100%;
}
.scores {
    xborder: 1px red solid;
}
.score{
    xborder: 1px green solid;
    float:left;
    width:25%;
}
body {
    font-family:sans-serif;
    font-size:0.8em;
}
</style>
<div class="scores">
    <div class="score">Hearts: <span id="score_hearts"></span></div>
    <div class="score">Value: <span id="score_value"></span></div>
</div>
<div style="clear:both;"/>
<div class="scores">
    <div class="score">Score: <span id="score_score"></span></div>
    <div class="score">Index: <span id="score_index"></span></div>
</div>
<div id="matrix"></div>

<h1>svg</h1>

<style>
.col0{
    fill:#ff0000;
}
.col2{
    fill:#00ff00;
}
.col2{
    fill:#00ff00;
}
.col2{
    fill:#00ff00;
}
</style>
<div style="display:none;">
<svg xmlns="http://www.w3.org/2000/svg" id="heart0" viewBox="0 0 645 585">
   <g> <path class="col0" d="M 297.29747,550.86823 C 283.52243,535.43191 249.1268,505.33855 220.86277,483.99412 C 137.11867,420.75228 125.72108,411.5999 91.719238,380.29088 C 29.03471,322.57071 2.413622,264.58086 2.5048478,185.95124 C 2.5493594,147.56739 5.1656152,132.77929 15.914734,110.15398 C 34.151433,71.768267 61.014996,43.244667 95.360052,25.799457 C 119.68545,13.443675 131.6827,7.9542046 172.30448,7.7296236 C 214.79777,7.4947896 223.74311,12.449347 248.73919,26.181459 C 279.1637,42.895777 310.47909,78.617167 316.95242,103.99205 L 320.95052,119.66445 L 330.81015,98.079942 C 386.52632,-23.892986 564.40851,-22.06811 626.31244,101.11153 C 645.95011,140.18758 648.10608,223.6247 630.69256,270.6244 C 607.97729,331.93377 565.31255,378.67493 466.68622,450.30098 C 402.0054,497.27462 328.80148,568.34684 323.70555,578.32901 C 317.79007,589.91654 323.42339,580.14491 297.29747,550.86823 z"/> </g> 
</svg>
<svg xmlns="http://www.w3.org/2000/svg" id="heart1" viewBox="0 0 645 585">
   <g> <path class="col2" d="M 297.29747,550.86823 C 283.52243,535.43191 249.1268,505.33855 220.86277,483.99412 C 137.11867,420.75228 125.72108,411.5999 91.719238,380.29088 C 29.03471,322.57071 2.413622,264.58086 2.5048478,185.95124 C 2.5493594,147.56739 5.1656152,132.77929 15.914734,110.15398 C 34.151433,71.768267 61.014996,43.244667 95.360052,25.799457 C 119.68545,13.443675 131.6827,7.9542046 172.30448,7.7296236 C 214.79777,7.4947896 223.74311,12.449347 248.73919,26.181459 C 279.1637,42.895777 310.47909,78.617167 316.95242,103.99205 L 320.95052,119.66445 L 330.81015,98.079942 C 386.52632,-23.892986 564.40851,-22.06811 626.31244,101.11153 C 645.95011,140.18758 648.10608,223.6247 630.69256,270.6244 C 607.97729,331.93377 565.31255,378.67493 466.68622,450.30098 C 402.0054,497.27462 328.80148,568.34684 323.70555,578.32901 C 317.79007,589.91654 323.42339,580.14491 297.29747,550.86823 z"/> </g> 
</svg>
<svg xmlns="http://www.w3.org/2000/svg" id="heart1" viewBox="0 0 645 585">
   <g> <path class="col3" d="M 297.29747,550.86823 C 283.52243,535.43191 249.1268,505.33855 220.86277,483.99412 C 137.11867,420.75228 125.72108,411.5999 91.719238,380.29088 C 29.03471,322.57071 2.413622,264.58086 2.5048478,185.95124 C 2.5493594,147.56739 5.1656152,132.77929 15.914734,110.15398 C 34.151433,71.768267 61.014996,43.244667 95.360052,25.799457 C 119.68545,13.443675 131.6827,7.9542046 172.30448,7.7296236 C 214.79777,7.4947896 223.74311,12.449347 248.73919,26.181459 C 279.1637,42.895777 310.47909,78.617167 316.95242,103.99205 L 320.95052,119.66445 L 330.81015,98.079942 C 386.52632,-23.892986 564.40851,-22.06811 626.31244,101.11153 C 645.95011,140.18758 648.10608,223.6247 630.69256,270.6244 C 607.97729,331.93377 565.31255,378.67493 466.68622,450.30098 C 402.0054,497.27462 328.80148,568.34684 323.70555,578.32901 C 317.79007,589.91654 323.42339,580.14491 297.29747,550.86823 z"/> </g> 
</svg>
<svg xmlns="http://www.w3.org/2000/svg" id="heart1" viewBox="0 0 645 585">
   <g> <path class="col4" d="M 297.29747,550.86823 C 283.52243,535.43191 249.1268,505.33855 220.86277,483.99412 C 137.11867,420.75228 125.72108,411.5999 91.719238,380.29088 C 29.03471,322.57071 2.413622,264.58086 2.5048478,185.95124 C 2.5493594,147.56739 5.1656152,132.77929 15.914734,110.15398 C 34.151433,71.768267 61.014996,43.244667 95.360052,25.799457 C 119.68545,13.443675 131.6827,7.9542046 172.30448,7.7296236 C 214.79777,7.4947896 223.74311,12.449347 248.73919,26.181459 C 279.1637,42.895777 310.47909,78.617167 316.95242,103.99205 L 320.95052,119.66445 L 330.81015,98.079942 C 386.52632,-23.892986 564.40851,-22.06811 626.31244,101.11153 C 645.95011,140.18758 648.10608,223.6247 630.69256,270.6244 C 607.97729,331.93377 565.31255,378.67493 466.68622,450.30098 C 402.0054,497.27462 328.80148,568.34684 323.70555,578.32901 C 317.79007,589.91654 323.42339,580.14491 297.29747,550.86823 z"/> </g> 
</svg>

</div>
<div class="item">
<svg xmlns="http://www.w3.org/2000/svg"><g><use xlink:href="#heart0"/></g></svg>
</div>
<!--
$($('#x1_3')[0]).attr('xlink:href', '#heart0')
-->
<div class="item">
<svg xmlns="http://www.w3.org/2000/svg"><g id="g1_3"><use id="x1_3" xlink:href="#heart1"/></g></svg>
</div>
</body>
</html>
